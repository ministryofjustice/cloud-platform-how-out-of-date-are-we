<!doctype html>
<html lang="en">

<head>
  <!-- Required meta tags -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
    integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
  <link rel="stylesheet" href="../static/stylesheet/stylesheet.css">
</head>

<body>
  <div class="container-fluid">
    <h2 class="page_heading">Summary</h2>
    <div class="row mb-3">
      <div class="col-sm-4">
        <div class="card">
          <div class="card-body">
            <b>Last Updated: </b>
            {{.LastUpdated}}
          </div>
        </div>
      </div>
      <div class="col-sm-4">
        <div class="card">
            <div class="card-body">
                <b>Number of namespaces erroring: </b><span id="namespaceCount"></span>
              </div>
        </div>
      </div>
    </div>
    <p class="text">
      Summary of namespaces currently erroring in Cloud Platform Concourse apply-live pipelines.
    </p>
    <p class="text">Type any namespace name to filter the list:</p>
    <input class="form-control" id="searchInput" type="text" placeholder="Search..">
    <br>
    <table class="table table-striped d-table" id="erroring-namespaces">
      <thead>
        <tr>
          <th>
            <button type="button" class="btn btn-outline-primary info" onclick="sortTable(0, true)">Namespace</button>
          </th>
          <th>
            <button type="button" class="btn btn-outline-primary info" onclick="sortTable(1, false)">Error message</button>
          </th>
        </tr>
      </thead>
      <tbody id="namespaceTable">
        {{- range .Namespaces }}
        <tr>
          <td>
            <a href="/namespace/{{.Namespace}}">{{.Namespace}}</a>
          </td>
          <td><code>{{.Error}}</code></td>
        </tr>
        {{- end }}
      </tbody>
    </table>
  </div>
  <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"
    integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj"
    crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.4.4/dist/umd/popper.min.js"
    integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN"
    crossorigin="anonymous"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"
    integrity="sha384-B4gt1jrGC7Jh4AgTPSdUtOBvfO8shuf57BaghqFfPlYxofvL8/KUEfYiJOMMV+rV"
    crossorigin="anonymous"></script>
  <script src="../static/assets/js/nav-bar.js"></script>

  <script>
    $(document).ready(function () {
      $("#searchInput").on("keyup", function () {
        var value = $(this).val().toLowerCase();
        $("#namespaceTable tr").filter(function () {
          $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1)
        });
      });
    });

    function isSortedAlphabetically(arr, n) {
      const c = [];

      for (let i = 1; i < arr.length; i++) {
        c.push(arr[i - 1].cells[n].textContent.localeCompare(arr[i].cells[n].textContent));
      }

      if (c.every((n) => n <= 0)) {
        return true
      }

      if (c.every((n) => n >= 0)) {
        return true
      };

      return false;
    }

    function isAscending(arr, n, isLetter) {
      return arr.every(function (x, i) {
        return i === 0 || parseFloat(x.cells[n].textContent).toFixed(2) * 100 <= parseFloat(arr[i - 1].cells[n].textContent).toFixed(2) * 100;
      });
    }

    function isDescending(arr, n) {
      return arr.every(function (x, i) {
        return i === 0 || parseFloat(x.cells[n].textContent).toFixed(2) * 100 >= parseFloat(arr[i - 1].cells[n].textContent).toFixed(2) * 100;
      });
    }

    function sortTable(n, isLetter) {
      table = document.getElementById("erroring-namespaces");

      var rows = Array.prototype.slice.call(table.querySelectorAll("tbody > tr"));

      rows = rows.slice(0, rows.length)

      var isSorted = false

      if (isLetter) {
        isSorted = isSortedAlphabetically(rows, n)
      } else {
        isSorted = isAscending(rows, n) || isDescending(rows, n)
      }


      if (isSorted) {
        rows.reverse()
      } else {
        rows.sort(function (rowA, rowB) {
          var cellA = rowA.cells[n].textContent;
          var cellB = rowB.cells[n].textContent;

          // Handle numerical values
          if (!isNaN(cellA) && !isNaN(cellB)) {
            return parseFloat(cellA).toFixed(2) * 100 - parseFloat(cellB).toFixed(2) * 100;
          }

          // Default to string comparison
          return cellA.localeCompare(cellB);
        });

      }

      rows.forEach(function (row) {
        table.querySelector("tbody").appendChild(row);
      });
    }
  </script>
  <script>
    document.addEventListener("DOMContentLoaded", function() {
      var namespaceCount = document.querySelectorAll("#namespaceTable tr").length;
      document.getElementById("namespaceCount").textContent = namespaceCount;
    });
  </script>
</body>

</html>